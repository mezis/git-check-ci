#!/usr/bin/env ruby
#
# Check the status of the CI server, and print a block coloured accordingly.
# Add me to your prompt!
# 
# Usage:
# 
# Configure your CI info in Git
# 
# $ git config --global ci.url <url>
# $ git config ci.project <project>
# 
# The tool will call curl(1), so make sure it's in your PATH and 
# configure ~/.netrc as necessary.
#
require 'pathname'

libdir = Pathname.new(__FILE__).join('../../lib').realpath
$:.unshift(libdir) unless $:.include?(libdir)


# We need to achieve less than 100ms response time here, so requiring Rubygems
# is not an option. Do some manual magic.
if ARGV == ['fast-check']
  require 'git-check-ci/config'

  printf GitCheckCI::Config.ci.status(:default => '?').to_s
  # fork, daemonize, spawn server if necessary
  if pid = fork
    Process.detach(pid)
  else
    require 'git-check-ci/server'
    GitCheckCI::Server.new.start(:quiet => true)
  end
  exit 0
end

# Otherwise start the full-fledged tool
require 'git-check-ci/shell'
GitCheckCI::Shell.start
